<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Admin</title>
    <link rel="stylesheet" type="text/css" href="mainGridOperator.css">
    <script src="./node_modules/web3/dist/web3.min.js"></script>
</head>

<body>
    <form method="POST">
        <div class="col-md-6 col align-self-center ">
            Username: <input id="log-Username" type="text">
        </div>
        <div data-role="fieldcontain">
            <input id="login" value="Search" type="button" onclick="getLog();">
        </div>
        <div class="col-md-6 col align-self-center ">
            <table class="table table-condensed" id="tableAdminLog">
                <thead>
                    <tr>
                        <th>Wallet Address</th>
                        <th>User Name</th>
                        <th>User Type</th>
                        <th>Transaction Time</th>
                    </tr>
                </thead>
            </table>
        </div>
        <br><br>
        <div data-role="fieldcontain">
            <select id="field-userType">
                <option value="EnergyProducer">EnergyProducer</option>
                <option value="EnergyGridOperator">EnergyGridOperator</option>
                <option value="EnergyTrader">EnergyTrader</option>
                <option value="EnergyStation">EnergyStation</option>
            </select>
        </div>
        <div data-role="fieldcontain">
            <input id="offer" value="Search" type="button" onclick="getOfferLog();">
        </div>
        <div class="col-md-6 col align-self-center ">
            <table class="table table-condensed" id="tableAdminLogOffer">
                <thead>
                    <tr>
                        <th>User Name</th>
                        <th>Price</th>
                    </tr>
                </thead>
            </table>
        </div>
    </form>

    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>
    <script>
        try {
            if (typeof web3 !== 'undefined') {
                web3 = new Web3(web3.currentProvider);
            } else {
                // Set the provider you want from Web3.providers
                web3 = new Web3(new Web3.providers.HttpProvider("HTTP://localhost:7545"));
            }
            // Default account defination
            web3.eth.defaultAccount = web3.eth.accounts[0];
            // Initialize contract with its ABI
            var myContractLoginRegister = web3.eth.contract([{"constant":false,"inputs":[],"name":"Time_call","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_userName","type":"string"},{"name":"_userPassworde","type":"string"}],"name":"checkUserLogin","outputs":[{"name":"","type":"string"},{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_userWalletAdress","type":"string"},{"name":"_userName","type":"string"},{"name":"_userPassworde","type":"string"},{"name":"_userType","type":"string"}],"name":"userRegister","outputs":[{"name":"","type":"string"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"_userName","type":"string"}],"name":"getUserLogLength","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"adminLogLength","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"adminLogStruct","outputs":[{"name":"userWalletAdress","type":"string"},{"name":"userName","type":"string"},{"name":"userType","type":"string"},{"name":"time","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"userInfoStruct","outputs":[{"name":"userWalletAdress","type":"string"},{"name":"userName","type":"string"},{"name":"userPassword","type":"string"},{"name":"userType","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"_userName","type":"string"},{"name":"startIndex","type":"uint256"}],"name":"getUserLog","outputs":[{"name":"","type":"string"},{"name":"","type":"string"},{"name":"","type":"string"},{"name":"","type":"uint256"},{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"inputs":[],"payable":false,"stateMutability":"nonpayable","type":"constructor"}]);
            var SContractLoginRegister = myContractLoginRegister.at('0x821a3e26c19eeade712ea2c511e346779e5ae81e');

            var myContractTrade = web3.eth.contract([{ "constant": true, "inputs": [{ "name": "_ownerName", "type": "string" }, { "name": "_ownerType", "type": "uint256" }], "name": "getCurrentUserTransactionLength", "outputs": [{ "name": "", "type": "uint256" }], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": true, "inputs": [{ "name": "_ownerName", "type": "string" }, { "name": "startIndex", "type": "uint256" }, { "name": "wantedOwnerType", "type": "uint256" }], "name": "getCurrentUserAllTransactions", "outputs": [{ "name": "", "type": "string" }, { "name": "", "type": "uint256" }, { "name": "", "type": "uint256" }], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": true, "inputs": [{ "name": "_ownerType", "type": "uint256" }], "name": "getMinEnergyPriceAccordingToOwnerType", "outputs": [{ "name": "", "type": "string" }, { "name": "", "type": "uint256" }], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": true, "inputs": [{ "name": "", "type": "uint256" }], "name": "productInfoStruct", "outputs": [{ "name": "ownerName", "type": "string" }, { "name": "energyPrice", "type": "uint256" }, { "name": "ownerType", "type": "uint256" }], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": true, "inputs": [{ "name": "startIndex", "type": "uint256" }, { "name": "wantedOwnerType", "type": "uint256" }], "name": "wantedValueofProductInfoStruct", "outputs": [{ "name": "", "type": "string" }, { "name": "", "type": "uint256" }, { "name": "", "type": "uint256" }], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": true, "inputs": [{ "name": "_ownerType", "type": "uint256" }], "name": "getAnOwnerLength", "outputs": [{ "name": "", "type": "uint256" }], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": false, "inputs": [{ "name": "ownerName", "type": "string" }, { "name": "energyPrice", "type": "uint256" }, { "name": "_ownerType", "type": "uint256" }, { "name": "profitRate", "type": "uint256" }], "name": "addOffer", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "inputs": [], "payable": false, "stateMutability": "nonpayable", "type": "constructor" }]);
            var SContractTrade = myContractTrade.at('0xdcd2335c2c86139e8fdf8523aab178340e86a9f7');
        }
        catch (e) {
            console.log(e);
        }

        function getLog() {
            var username = document.getElementById("log-Username").value;
            var numberOfLog = SContract.getUserLogLength(username);
            var i;
            var index = 0;// First starting index is 0
            for (i = 0; i < numberOfLog; i++) {
                var result = SContract.getUserLog(username, index);//Smart contract function. Find the next Grid operator.
                var table = document.getElementById("tableAdminLog");
                var row = table.insertRow(1);

                var cell_wallet = row.insertCell(0);
                var cell_userName = row.insertCell(1);
                var cell_userType = row.insertCell(2);
                var cell_time = row.insertCell(3);

                var date = new Date(result[3] * 1000);
                var formattedDate = ('0' + date.getDate()).slice(-2) + '/' + ('0' + (date.getMonth() + 1)).slice(-2) + '/' + date.getFullYear() + ' ' + ('0' + date.getHours()).slice(-2) + ':' + ('0' + date.getMinutes()).slice(-2);

                cell_wallet.innerHTML = result[0];//Add Table
                cell_userName.innerHTML = result[1];//Add Table
                cell_userType.innerHTML = result[2];//Add Table
                cell_time.innerHTML = formattedDate;//Add Table
                index = result[4];// New index is return value of smart function.
            }
        };
        var tableLenght = 0;
        function getOfferLog() {
            for (var i = tableLenght; i >=1; i--) {
                document.getElementById("tableAdminLogOffer").deleteRow(i);
            }
            var username = document.getElementById("log-Username").value;

            var e = document.getElementById("field-userType");
            var userType = e.options[e.selectedIndex].value;
            var _userType;
            if (userType == "EnergyProducer") _userType = 0;
            else if (userType == "EnergyGridOperator") _userType = 1;
            else if (userType == "EnergyTrader") _userType = 2;
            else _userType = 3;
            if (username != "") {
                var numberOfOffers = SContractTrade.getCurrentUserTransactionLength(username, _userType);// Get how many offers of Grid Operators.
                tableLenght = numberOfOffers;
                var i;
                var index = 0;// First starting index is 0
                for (i = 0; i < numberOfOffers; i++) {
                    var result = SContractTrade.getCurrentUserAllTransactions(username, index, _userType);//Smart contract function. Find the next Grid operator.
                    var table = document.getElementById("tableAdminLogOffer");
                    var row = table.insertRow(1);
                    var cell1 = row.insertCell(0);
                    var cell2 = row.insertCell(1);
                    cell1.innerHTML = result[0];//Add Table
                    cell2.innerHTML = result[1];//Add Table
                    index = result[2];// New index is return value of smart function.
                }
            } else {
                var length = SContractTrade.getAnOwnerLength(_userType);
                tableLenght = length;
                var i;
                var index = 0;// First starting index is 0
                for (i = 0; i < length; i++) {
                    var result = SContractTrade.wantedValueofProductInfoStruct(index, _userType);//Smart contract function. Find the next Energy Producer.
                    var table = document.getElementById("tableAdminLogOffer");
                    var row = table.insertRow(1);
                    var cell1 = row.insertCell(0);
                    var cell2 = row.insertCell(1);
                    cell1.innerHTML = result[0];//Add Table
                    cell2.innerHTML = result[1];//Add Table
                    index = result[2];// New index is return value of smart contract function.
                }
            }

        };


    </script>
</body>

</html>