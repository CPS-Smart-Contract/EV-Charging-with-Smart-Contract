<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Register</title>
    <!-- plugins:css -->
    <link rel="stylesheet" href="./vendors/iconfonts/mdi/css/materialdesignicons.min.css">
    <link rel="stylesheet" href="./vendors/css/vendor.bundle.base.css">
    <link rel="stylesheet" href="./vendors/css/vendor.bundle.addons.css">
    <!-- endinject -->
    <!-- plugin css for this page -->
    <!-- End plugin css for this page -->
    <!-- inject:css -->
    <link rel="stylesheet" href="./css/style.css">
    <!-- endinject -->
    <link rel="shortcut icon" href="./images/favicon.png" />
    <script src="./node_modules/web3/dist/web3.min.js"></script>
</head>

<body>
    <div class="container-scroller">
        <div class="container-fluid page-body-wrapper full-page-wrapper auth-page">
            <div class="content-wrapper d-flex align-items-center auth register-bg-1 theme-one">
                <div class="row w-100">
                    <div class="col-lg-4 mx-auto">
                        <h2 class="text-center mb-4">Register</h2>
                        <div class="auto-form-wrapper">
                            <form action="">

                                <div class="form-group">
                                    <div class="input-group">
                                        <input name="input_userWalletAddress" id="field-userWalletAddress" type="text"
                                            class="form-control" placeholder="User Wallet Address">
                                        <div class="input-group-append">
                                            <span class="input-group-text">
                                                <i class="mdi mdi-check-circle-outline"></i>
                                            </span>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <div class="input-group">
                                        <input name="input_userName" id="field-userName" type="text" class="form-control"
                                            placeholder="Username">
                                        <div class="input-group-append">
                                            <span class="input-group-text">
                                                <i class="mdi mdi-check-circle-outline"></i>
                                            </span>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <div class="input-group">
                                        <input name="input_userPassword" id="field-password" type="password" class="form-control"
                                            placeholder="Password">
                                        <div class="input-group-append">
                                            <span class="input-group-text">
                                                <i class="mdi mdi-check-circle-outline"></i>
                                            </span>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <div class="input-group">
                                        <input name="input_confirmPassword" id="field-confirmPassword" type="password"
                                            class="form-control" placeholder="Confirm Password">
                                        <div class="input-group-append">
                                            <span class="input-group-text">
                                                <i class="mdi mdi-check-circle-outline"></i>
                                            </span>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <div class="input-group">
                                        <select id="field-userType">
                                            <option value="EnergyProducer">Energy Producer</option>
                                            <option value="EnergyGridOperator">Energy Grid Operator</option>
                                            <option value="EnergyTrader">Energy Trader</option>
                                            <option value="EnergyStation">Energy Station</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="form-group d-flex justify-content-center">
                                    <div class="form-check form-check-flat mt-0">
                                        <label class="form-check-label">
                                            <input type="checkbox" class="form-check-input" checked> I agree to the
                                            terms
                                        </label>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <input class="btn btn-primary submit-btn btn-block" id="btnRegister" value="Register"
                                        type="button" onclick="userRegister();">
                                </div>
                                <div class="text-block text-center my-3">
                                    <span class="text-small font-weight-semibold">Already have and account ?</span>
                                    <a href="Login.html" class="text-black text-small">Login</a>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <!-- content-wrapper ends -->
        </div>
        <!-- page-body-wrapper ends -->
    </div>

    <script src="./vendors/js/vendor.bundle.base.js"></script>
    <script src="./vendors/js/vendor.bundle.addons.js"></script>
    <script src="./js/off-canvas.js"></script>
    <script src="./js/misc.js"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>
    <script>

        function userRegister() {
            try {
                var _userWalletAddress = document.getElementById('field-userWalletAddress').value;
                var _userName = document.getElementById('field-userName').value;
                var _userPassword = document.getElementById('field-password').value;
                var _confirmPassword = document.getElementById('field-confirmPassword').value;
                // Html select tag definition for selected user type.
                var e = document.getElementById("field-userType");
                var userType = e.options[e.selectedIndex].value;

                // If user wallet address is empty, focus this field.
                if (_userWalletAddress == "") {
                    alert('please enter user wallet address');
                    document.myregister.input_userWalletAddress.focus();
                }
                // If user name is empty, focus this field.
                else if (_userName == "") {
                    alert('please enter username');
                    document.myregister.input_userName.focus();
                }
                // If user password is empty, focus this field.
                else if (_userPassword == "") {
                    alert('please enter password');
                    document.myregister.input_userPassword.focus();
                }
                else if (_userPassword != _confirmPassword) {
                    alert('Password not match');
                    document.myregister.input_userPassword.focus();
                }
                else {
                    if (typeof web3 !== 'undefined') {
                        web3 = new Web3(web3.currentProvider);
                    } else {
                        // Set the provider you want from Web3.providers.
                        web3 = new Web3(new Web3.providers.HttpProvider("HTTP://localhost:7545"));
                    }
                    // Default account defination.
                    web3.eth.defaultAccount = web3.eth.accounts[0];
                    // Initialize contract with its ABI.
                    var myContract =  web3.eth.contract([{"constant":false,"inputs":[],"name":"Time_call","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_userName","type":"string"},{"name":"_userPassworde","type":"string"}],"name":"checkUserLogin","outputs":[{"name":"","type":"string"},{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_userWalletAdress","type":"string"},{"name":"_userName","type":"string"},{"name":"_userPassworde","type":"string"},{"name":"_userType","type":"string"}],"name":"userRegister","outputs":[{"name":"","type":"string"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"_userName","type":"string"}],"name":"getUserLogLength","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"adminLogLength","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"adminLogStruct","outputs":[{"name":"userWalletAdress","type":"string"},{"name":"userName","type":"string"},{"name":"userType","type":"string"},{"name":"time","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"userInfoStruct","outputs":[{"name":"userWalletAdress","type":"string"},{"name":"userName","type":"string"},{"name":"userPassword","type":"string"},{"name":"userType","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"_userName","type":"string"},{"name":"startIndex","type":"uint256"}],"name":"getUserLog","outputs":[{"name":"","type":"string"},{"name":"","type":"string"},{"name":"","type":"string"},{"name":"","type":"uint256"},{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"inputs":[],"payable":false,"stateMutability":"nonpayable","type":"constructor"}]);
                    // Contract defination of smart deployed contract with its address.
                    var SContract = myContract.at('0x3129eaf1760e374a6feeac07b262c6092568c383');
                    // Contract userRegister function access with user information.

                    SContract.checkUserLogin.call(_userName, _userPassword, (error, result) => {
                        if (error) {
                            return console.log(error);
                        } else {
                            console.log(result[1]);
                            if (result[1] == true) {
                                alert('Invalid User');
                            } else {
                                SContract.userRegister.sendTransaction(_userWalletAddress, _userName, _userPassword, userType, { from: web3.eth.accounts[0], gas: 3000000 }, (error, result) => {
                                    if (error) {
                                        return console.log(error);
                                    }
                                    else {
                                        console.log("txhash: " + result);
                                        alert('Registration Success');
                                        document.getElementById('field-userWalletAddress').value = "";
                                        document.getElementById('field-userName').value = "";
                                        document.getElementById('field-password').value = "";
                                        document.getElementById('field-confirmPassword').value = "";
                                    }
                                });
                            }
                        }
                    });
                }
            } catch (e) {
                console.log(e);
            }
        }
    </script>

</body>

</html>